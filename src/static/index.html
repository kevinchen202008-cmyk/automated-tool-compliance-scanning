<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>工具合规扫描 Agent</title>
  <style>
    :root { --bg: #0f1419; --card: #1a2332; --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff; --success: #3fb950; --warn: #d29922; --danger: #f85149; --border: #30363d; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 24px; min-height: 100vh; }
    .container { max-width: 980px; margin: 0 auto; }
    h1 { font-size: 1.5rem; margin-bottom: 8px; }
    .sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 16px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab { padding: 6px 12px; border-radius: 999px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 13px; cursor: pointer; }
    .tab.active { background: var(--card); color: var(--accent); border-color: var(--accent); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
    label { display: block; margin-bottom: 6px; color: var(--muted); font-size: 0.85rem; }
    textarea { width: 100%; min-height: 100px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; resize: vertical; }
    .btn { display: inline-block; padding: 10px 18px; background: var(--accent); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-right: 8px; margin-top: 8px; }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .task-item { padding: 10px 12px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
    .task-item.pending { background: rgba(88,166,255,0.1); border-color: var(--accent); }
    .task-item.done { background: rgba(63,185,80,0.1); border-color: var(--success); }
    .task-item.error { background: rgba(248,81,73,0.1); border-color: var(--danger); }
    .task-name { font-weight: 500; }
    .task-status { color: var(--muted); font-size: 13px; }

    /* === 扫描结果卡片 === */
    .result-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-top: 20px; }
    .result-card h2 { font-size: 1.25rem; margin: 0 0 20px 0; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
    .result-section { margin-bottom: 20px; }
    .result-section h3 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin: 0 0 8px 0; }
    .result-section .row { font-size: 14px; line-height: 1.6; margin: 4px 0; }
    .result-section .label { color: var(--muted); margin-right: 8px; }
    .yes { color: var(--success); }
    .no { color: var(--danger); }
    .china-yes { color: var(--success); }
    .alt-block { background: var(--bg); border-radius: 8px; padding: 12px; margin-top: 12px; }
    .alt-block h4 { font-size: 14px; margin: 0 0 6px 0; }
    .alt-block .meta { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .alt-block .desc { font-size: 13px; line-height: 1.5; }

    /* === 数据来源 & 知识库横幅 === */
    .data-source-badge { font-size: 0.75rem; color: var(--muted); margin-bottom: 12px; }
    .data-source-badge span { padding: 2px 8px; border-radius: 4px; background: var(--bg); border: 1px solid var(--border); }
    .data-source-badge.mixed span { border-color: var(--warn); color: var(--warn); }
    .data-source-badge.ai span { border-color: var(--accent); color: var(--accent); }
    .data-source-badge.kb span { color: var(--success); border-color: var(--success); }
    .kb-banner { padding: 10px 12px; border-radius: 8px; border: 1px dashed var(--border); font-size: 13px; margin-top: 8px; }
    .kb-banner.new { border-color: var(--accent); }
    .kb-banner.diff { border-color: var(--warn); }
    .kb-actions { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; }
    .btn-sm { padding: 6px 10px; font-size: 12px; border-radius: 6px; }

    /* === 工具库浏览 === */
    .kb-browse-card { margin-bottom: 16px; }
    .kb-toolbar { margin-top: 8px; font-size: 13px; display: flex; align-items: center; gap: 8px; color: var(--muted); flex-wrap: wrap; }
    .kb-toolbar select { padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 13px; }
    .kb-panel { display: flex; gap: 20px; margin-top: 16px; align-items: stretch; min-height: 320px; }
    .kb-left { width: 260px; flex-shrink: 0; display: flex; flex-direction: column; }
    .kb-left .kb-search { width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; margin-bottom: 10px; }
    .kb-list { display: flex; flex-direction: column; gap: 6px; overflow-y: auto; flex: 1; min-height: 0; }
    .kb-list-item { padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 13px; text-align: left; width: 100%; display: block; color: var(--text); }
    .kb-list-item:hover { border-color: var(--accent); }
    .kb-list-item:hover .kb-list-name { color: var(--accent); }
    .kb-list-item.active { border-color: var(--accent); background: rgba(88,166,255,0.15); }
    .kb-list-item.active .kb-list-name { color: var(--accent); }
    .kb-list-name { display: block; color: var(--text); }
    .kb-list-license { display: block; font-size: 11px; margin-top: 0; max-height: 0; overflow: hidden; opacity: 0; line-height: 0; transition: opacity 0.15s, max-height 0.2s, margin-top 0.15s; }
    .kb-list-item:hover .kb-list-license, .kb-list-item:focus .kb-list-license { opacity: 1; max-height: 2em; line-height: 1.3; margin-top: 4px; }
    .kb-list-license.license-open { color: var(--accent); }
    .kb-list-license.license-commercial { color: var(--warn); }
    .kb-right { flex: 1; min-width: 0; overflow-y: auto; }
    .kb-detail-card { height: 100%; }
    .kb-detail-card .result-card { margin-top: 0; }
    .kb-detail-actions { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 10px; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { opacity: 0.9; }

    /* === 编辑表单 === */
    .kb-edit-form .form-row { margin-bottom: 12px; }
    .kb-edit-form label { display: block; margin-bottom: 4px; color: var(--muted); font-size: 0.85rem; }
    .kb-edit-form input[type="text"], .kb-edit-form textarea { width: 100%; padding: 8px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px; }
    .kb-edit-form textarea { min-height: 80px; resize: vertical; }
    .kb-edit-form input[type="checkbox"] { margin-right: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>工具合规扫描 Agent</h1>
    <p class="sub">默认显示「合规扫描」结果；如需长期维护某个工具的合规信息，可切换到「工具库浏览」进行浏览和编辑。</p>

    <!-- === Tab 切换 === -->
    <div class="tabs">
      <button class="tab active" data-view="scan">合规扫描</button>
      <button class="tab" data-view="kb">工具库浏览</button>
    </div>

    <!-- === 合规扫描视图 === -->
    <div id="viewScan">
      <div class="card">
        <label for="tools">工具名称（每行一个或逗号分隔）</label>
        <textarea id="tools" placeholder="例如：&#10;Docker Desktop&#10;Docker CE&#10;Git"></textarea>
        <button class="btn" id="startBtn">开始扫描</button>
      </div>
      <div class="card" id="progressCard" style="display: none;">
        <strong>扫描进展</strong>
        <div id="taskList"></div>
      </div>
      <div id="resultContainer"></div>
    </div>

    <!-- === 工具库浏览视图 === -->
    <div id="viewKb" style="display: none;">
      <div class="card kb-browse-card" id="kbBrowseCard">
        <p class="sub" style="margin-bottom:12px;">
          简介：按名称或许可/协议类型快速排序/筛选已入库的工具，集中查看其许可证、公司信息和商用使用限制等合规关键信息，支持在线编辑、删除及导出当前列表，便于合规模板复核与日常维护。
        </p>
        <button class="btn" id="kbLoadListBtn">加载工具信息库列表</button>
        <div class="kb-toolbar">
          <span>排序：</span>
          <select id="kbOrder">
            <option value="tool_name">按名称</option>
            <option value="updated_at">按更新时间</option>
          </select>
          <span style="margin-left:16px;">许可/协议：</span>
          <select id="kbLicenseFilter">
            <option value="all">全部</option>
            <option value="open">开源类</option>
            <option value="commercial">商业许可</option>
            <option value="other">其他/未知</option>
          </select>
          <span style="margin-left:auto;font-size:12px;">导出：</span>
          <button type="button" class="btn btn-sm" id="kbExportBtn">导出当前列表</button>
        </div>
        <div class="kb-panel" id="kbPanel" style="display: none;">
          <div class="kb-left">
            <input type="text" class="kb-search" id="kbSearch" placeholder="按工具名称筛选…" />
            <div id="kbList" class="kb-list"></div>
          </div>
          <div class="kb-right">
            <div id="kbDetail" class="kb-detail-card"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- === JS 模块 === -->
  <script src="/static/js/utils.js"></script>
  <script src="/static/js/scan.js"></script>
  <script src="/static/js/kb-browse.js"></script>
  <script>
    // Tab 切换
    (function setupTabs() {
      var scanView = document.getElementById('viewScan');
      var kbView = document.getElementById('viewKb');
      var tabs = document.querySelectorAll('.tab');
      tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          tabs.forEach(function(t) { t.classList.remove('active'); });
          this.classList.add('active');
          var view = this.getAttribute('data-view');
          if (view === 'kb') {
            scanView.style.display = 'none';
            kbView.style.display = 'block';
          } else {
            scanView.style.display = 'block';
            kbView.style.display = 'none';
          }
        });
      });
    })();

    // 初始化各模块
    initScan();
    initKbBrowse();
  </script>
</body>
</html>
