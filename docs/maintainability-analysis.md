# 项目可维护性分析与优化建议

> 基于当前代码与文档的静态分析，供后续迭代参考。

---

## 1. 当前可维护性概览

| 维度 | 现状 | 简要结论 |
|------|------|----------|
| **结构清晰度** | 单入口 `main.py` + `src/services/*` + 单页 `index.html` | 后端分层清楚；前端集中单文件，随功能增加会变重 |
| **配置与环境** | `config.yaml` + Pydantic + `CONFIG_PATH` / 默认路径 | 配置有校验、可挂载，易扩展 |
| **依赖** | `requirements.txt` 固定版本 | 复现性好；需定期评估升级 |
| **文档** | README、PRD、架构、流程、部署文档齐全 | 新成员上手路径清晰 |
| **测试** | `tests/` 有 config/database/logger/main 等 | 覆盖偏基础；缺扫描/KB/API 的集成或 E2E |
| **部署** | Docker + 阿里云 ECS + GitHub Actions | 一条龙可复现，可维护 |
| **日志与排障** | Loguru + 敏感信息过滤 + 落盘 | 便于排查；可再统一审计格式 |

**结论**：整体可维护性中等偏上；主要风险在「单文件前端膨胀」和「测试覆盖不足」，其余通过小步优化即可提升。

---

## 2. 主要风险与问题

### 2.1 前端单文件过重

- **现象**：`src/static/index.html` 约 800 行，承担合规扫描 UI、工具库浏览、筛选/排序、导出、编辑/删除等全部逻辑。
- **影响**：多人协作易冲突；修改一处可能影响全局；难以做按需加载或单元级测试。
- **建议**（按优先级）：
  1. **短期**：在文件内用注释分区（如 `// === 合规扫描` / `// === 工具库浏览`），并收敛重复片段为少量 JS 函数。
  2. **中期**：将「工具库浏览」整块拆成独立 JS 文件（如 `kb-browse.js`），在 `index.html` 中引用，便于分工和复用。
  3. **长期**：若继续加复杂交互，可引入轻量框架（如 Alpine 或 Vue 单页）或至少模块化脚本。

### 2.2 测试覆盖不足

- **现象**：`tests/` 仅有根路径、健康检查等基础用例；无扫描流程、知识库 CRUD、报告生成等接口或集成测试。
- **影响**：重构或改配置时易引入回归；上线前主要靠人工验证。
- **建议**：
  1. 为 `POST /api/v1/tools/batch`、`POST /api/v1/scan/start`、`GET /api/v1/reports/{id}` 等核心接口补充 pytest + TestClient 的接口测试（可 mock AI 与 DB）。
  2. 对 `knowledge_base_service` / `report_service` 做单元测试（给定内存或 SQLite，断言返回结构）。
  3. 在 CI 中增加 `pytest tests/`，保证每次 push 跑一遍。

### 2.3 根目录零散 Markdown

- **现象**：根目录存在多份 `.md`（如 `FIX_SUMMARY.md`、`GLM_API_ANALYSIS.md`、`KNOWLEDGE_BASE_FEATURE_SUMMARY.md` 等），与 `docs/` 内文档职责重叠或过时。
- **影响**：新人不知道以哪份为准；历史说明与现行设计混在一起。
- **建议**：将根目录中「过程性/总结性」文档迁移到 `docs/` 或 `docs/archive/`，在 README 中只链接到 `docs/` 下的正式文档（如 `docs/prd.md`、`docs/architecture.md`、`docs/deploy-aliyun.md`），避免根目录堆积。

### 2.4 配置与密钥

- **现状**：`config.yaml` 已加入 `.gitignore`；示例用 `docs/config-example.yaml`；敏感信息未写进代码。
- **建议**：在 README 或 `docs/deploy-aliyun.md` 中明确写出「禁止提交 `config/config.yaml`」「生产环境用环境变量或挂载卷覆盖敏感项」，必要时在 CI 中增加一次「检查是否误提交 config.yaml」的步骤。

### 2.5 主入口体积

- **现象**：`src/main.py` 体量较大（约 900+ 行），路由、部分业务逻辑和响应构造都在同一文件。
- **影响**：单文件修改频率高，合并冲突和认知负担会上升。
- **建议**：按领域拆成路由模块（如 `src/routers/scan.py`、`src/routers/knowledge_base.py`），在 `main.py` 中 `include_router`，便于按功能分工和单测。

---

## 3. 优化建议汇总（按优先级）

| 优先级 | 项 | 说明 |
|--------|----|------|
| P1 | 为核心 API 和 KB/报告服务补充接口测试与少量单元测试，并在 CI 中运行 | 降低回归风险，便于重构 |
| P2 | 在 `index.html` 内分区、抽公共 JS，或拆出 `kb-browse.js` | 控制前端单文件膨胀，便于协作 |
| P3 | 根目录过程性 `.md` 迁至 `docs/` 或 `docs/archive/`，README 只链正式文档 | 文档入口清晰 |
| P4 | 将 `main.py` 按路由拆成 `routers/` | 降低单文件复杂度 |
| P5 | 在部署文档中明确「禁止提交 config 与密钥」并在 CI 做一次检查 | 避免误提交敏感配置 |

---

## 4. 小结

- **当前可维护性**：结构清晰、配置与部署文档齐全，具备持续演进基础；主要短板在「前端单文件」和「测试覆盖」。
- **建议**：优先补齐核心 API 与 KB 相关测试（P1），并逐步做前端拆分与主入口拆分（P2、P4）；文档与密钥规范（P3、P5）可穿插进行。  
以上建议可根据排期与人力做裁剪或分阶段实施。
